# VaudevilleRPG

A turn-based duel RPG game for Telegram with AI-generated content, dungeons, and competitive PvP.

![Python](https://img.shields.io/badge/Python-3.11+-blue.svg)
![Telegram](https://img.shields.io/badge/Telegram-Bot%20API-0088cc.svg)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-15+-336791.svg)
![Tests](https://img.shields.io/badge/Tests-284%20passing-brightgreen.svg)

---

## What is VaudevilleRPG?

VaudevilleRPG transforms any Telegram group chat into an RPG arena. Players equip items, battle each other in turn-based duels, and explore AI-generated dungeons to earn powerful gear.

**Key Highlights:**
- **AI-Generated Worlds** - Each chat gets a unique setting with custom items, abilities, and world rules generated by LLM
- **Turn-Based Combat** - Strategic duels with attack/defense/utility actions
- **PvP Duels** - Challenge other players, climb the Elo-rated leaderboard
- **PvE Dungeons** - Solo dungeon runs with scaling difficulty and loot rewards
- **Procedural Items** - Items with rarity-scaled effects and unique abilities

---

## Features

### Combat System
```
Turn Structure:
PRE_MOVE (poison ticks, buffs) -> Player Actions -> Combat Resolution -> POST_MOVE (stack decay)
```

- **4 Action Types**: Attack, Defense, Misc, Skip
- **Stack-based Attributes**: Poison, Armor, Might, and custom attributes per setting
- **Damage Interrupt System**: PRE_DAMAGE and POST_DAMAGE effects for armor, shields, thorns
- **Simultaneous Turns**: Both players choose secretly, then actions resolve

### Item System

| Slot | Purpose | Example |
|------|---------|---------|
| Attack | Deal damage, apply debuffs | Poisonous Sword, Fire Staff |
| Defense | Block damage, gain buffs | Iron Shield, Holy Ward |
| Misc | Healing, utility effects | Healing Potion, Counterspell Scroll |

Items scale by rarity: Common -> Uncommon -> Rare -> Epic -> Legendary

### Dungeons (PvE)

| Difficulty | Stages | Enemy HP | Reward Rarity |
|------------|--------|----------|---------------|
| Easy | 2 | 40-45 | Common |
| Normal | 3 | 70-90 | Common-Uncommon |
| Hard | 4 | 100-145 | Uncommon-Rare |
| Nightmare | 5 | 130-230 | Rare-Epic |

Defeat all enemies to claim item rewards!

### Rating System

- Elo-based competitive rating
- Starting rating: 1000
- Dynamic K-factor (40 for new players, 32 standard, 16 for 2000+ rating)
- Leaderboard tracks top players per chat

---

## Bot Commands

| Command | Description |
|---------|-------------|
| `/start` | Welcome message and game status |
| `/help` | Detailed help with all commands |
| `/profile` | View your stats, rating, and items |
| `/leaderboard` | Top 10 players in this chat |
| `/challenge` | Reply to a message to challenge that player |
| `/dungeon` | Start a PvE dungeon run |
| `/generate_setting` | (Admin) Generate a unique game world |

---

## Quick Start

### Prerequisites

- Python 3.11+
- PostgreSQL 15+
- Telegram Bot Token (from [@BotFather](https://t.me/BotFather))
- LLM API access (Anthropic Claude, OpenAI, or local vLLM)

### Installation

```bash
# Clone the repository
git clone https://github.com/OligerMan/vaudeville_rpg.git
cd vaudeville_rpg

# Create virtual environment
python -m venv .venv
.venv/Scripts/activate  # Windows
# source .venv/bin/activate  # Linux/Mac

# Install dependencies
pip install -e ".[dev]"
```

### Configuration

Create a `.env` file:

```env
# Telegram
BOT_TOKEN=your-bot-token-from-botfather

# Database
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/vaudeville_rpg

# LLM (choose one provider)
LLM_PROVIDER=anthropic
LLM_API_KEY=your-api-key
LLM_MODEL=claude-sonnet-4-20250514

# Admin (your Telegram user ID)
ADMIN_USER_IDS=123456789
```

### Database Setup

```bash
# Create database
createdb vaudeville_rpg

# Run migrations
alembic upgrade head
```

### Run the Bot

```bash
python -m vaudeville_rpg
```

---

## Local LLM Setup (vLLM with Docker)

For running with a local LLM instead of cloud APIs:

```bash
# Start vLLM server (requires NVIDIA GPU)
docker run --gpus all -p 8000:8000 vllm/vllm-openai:latest \
  --model Qwen/Qwen2.5-7B-Instruct-AWQ \
  --gpu-memory-utilization 0.9 \
  --max-model-len 4096
```

Update `.env`:
```env
LLM_PROVIDER=openai
LLM_BASE_URL=http://localhost:8000/v1
LLM_API_KEY=dummy
LLM_MODEL=Qwen/Qwen2.5-7B-Instruct-AWQ
```

---

## Development

### Running Tests

```bash
# Run all tests
pytest tests/ -v

# Run specific test file
pytest tests/test_integration_duels.py -v
```

### Code Quality

```bash
# Lint
python -m ruff check src/

# Format
python -m ruff format src/
```

### Project Structure

```
src/vaudeville_rpg/
├── bot/              # Telegram bot handlers
│   └── handlers/     # Command and callback handlers
├── db/               # Database models and engine
│   └── models/       # SQLAlchemy models
├── engine/           # Combat engine
│   ├── duel.py       # Main duel API
│   ├── turn.py       # Turn resolution
│   ├── effects.py    # Effect processing
│   └── logging.py    # Combat logging
├── llm/              # LLM content generation
│   ├── generators.py # Content generators
│   ├── validators.py # Output validation
│   └── parser.py     # JSON to DB models
├── services/         # Business logic services
└── utils/            # Utilities (rating calc, etc.)

tests/                # Test files
alembic/              # Database migrations
```

---

## Documentation

| File | Description |
|------|-------------|
| **[WIKI.md](WIKI.md)** | Complete game mechanics documentation - combat phases, effect system, item generation |
| **[PROGRESS.md](PROGRESS.md)** | Development progress tracking - session summaries, current tasks, setup instructions |
| **[CLAUDE.md](CLAUDE.md)** | AI assistant instructions - project context for Claude Code |

---

## Architecture Highlights

### Content Generation Pipeline

```
User Prompt -> Setting Generator -> World Rules -> Effect Templates -> Item Types -> Items
```

Each step is validated and can retry on failure. The pipeline creates a complete, balanced game world from a simple description like "medieval fantasy with dragons".

### Combat Engine

- **State Machine**: Duels track phase (NOT_STARTED -> PRE_MOVE_COMPLETE -> COMBAT_COMPLETE)
- **Persistence**: All combat state survives bot restarts
- **Effect Ordering**: Effects execute in alphabetical order by name
- **Interrupt System**: PRE_DAMAGE/POST_DAMAGE effects trigger on any damage event

### Database Design

- **Per-Chat Settings**: Each Telegram chat has independent game world
- **Player Profiles**: Same user has separate characters per chat
- **Combat State**: Full state persisted in PostgreSQL with JSONB for attribute stacks

---

## Tech Stack

| Component | Technology |
|-----------|------------|
| Bot Framework | [aiogram 3.x](https://docs.aiogram.dev/) |
| Database | PostgreSQL + [SQLAlchemy 2.0](https://www.sqlalchemy.org/) (async) |
| Migrations | [Alembic](https://alembic.sqlalchemy.org/) |
| LLM Integration | Anthropic Claude / OpenAI / vLLM |
| Configuration | [pydantic-settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/) |
| Testing | [pytest](https://pytest.org/) + pytest-asyncio |

---

## Contributing

1. Create a feature branch: `git checkout -b feature/your-feature`
2. Write tests for new functionality
3. Run linter and formatter: `ruff check --fix && ruff format`
4. Ensure all tests pass: `pytest`
5. Commit with conventional commits: `feat: Add new feature`
6. Open a pull request

---

## License

MIT License - feel free to use and modify for your own projects.

---

## Acknowledgments

Built with Claude Code - AI-powered development assistant by Anthropic.
